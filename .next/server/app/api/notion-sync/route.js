(()=>{var e={};e.id=283,e.ids=[283],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3708:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>R,routeModule:()=>_,serverHooks:()=>k,workAsyncStorage:()=>j,workUnitAsyncStorage:()=>h});var o={};n.r(o),n.d(o,{POST:()=>x});var a=n(6559),r=n(8088),s=n(7719),d=n(7574),i=n(6891),l=n(5828);let u=Deno.env.get("NOTION_API_KEY"),m=Deno.env.get("NEXT_PUBLIC_SUPABASE_URL"),p=Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),c=Deno.env.get("WEBHOOK_SECRET"),g=u?new i.Client({auth:u}):null,b=m&&p?(0,l.createClient)(m,p,{auth:{persistSession:!1}}):null;async function x(e){let t;if(!c)return d.NextResponse.json({error:"Server misconfig"},{status:500});let n=e.headers.get("Authorization");if(!n||!n.startsWith("Bearer ")||n.substring(7)!==c)return d.NextResponse.json({error:"Unauthorized"},{status:401});if(!b||!g)return d.NextResponse.json({error:"Server not configured (supabase or notion)"},{status:500});try{t=await e.json()}catch{return d.NextResponse.json({error:"Invalid JSON"},{status:400})}let{taskId:o}=t;if(!o)return d.NextResponse.json({error:"taskId required"},{status:400});let{data:a,error:r}=await b.from("transcription_tasks").select("*").eq("id",o).single();if(r||!a)return d.NextResponse.json({error:"Task not found"},{status:404});let{consultant_name:s="なし",company_name:i="なし",company_type:l="エラー",company_problem:u="なし",meeting_date:m="なし",meeting_count:p,meeting_type:x="エラー",support_area:_="エラー",company_phase:j="なし",internal_sharing_items:h="なし",final_summary:k}=a;if(!k)return d.NextResponse.json({error:"final_summary missing"},{status:400});let{data:R,error:f}=await b.from("notion_db_map").select("*").in("kind",["all","consultant","company"]).in("name",[s,i,"all"]);if(f)return d.NextResponse.json({error:f.message},{status:500});let C=R??[],w=(e,t,n)=>e.find(e=>e.kind===t&&e.name===n),D=w(C,"all","all"),y=w(C,"consultant",s),N=w(C,"company",i);if(!D||!y||!N)return await b.from("transcription_tasks").update({status:"notion_failed",error_message:"Mapping not found"}).eq("id",o),d.NextResponse.json({error:"Mapping not found for some target DB"},{status:400});let v=()=>({面談日:{title:[{text:{content:`${m}`}}]},企業名:{rich_text:[{text:{content:i||"なし"}}]},コンサルタント名:{rich_text:[{text:{content:s||"なし"}}]},企業タイプ:{status:{name:l||"エラー"}},企業の課題:{rich_text:[{text:{content:u||"なし"}}]},面談回数:{number:p??null},支援領域:{status:{name:_||"エラー"}},企業のフェーズ:{rich_text:[{text:{content:j||"なし"}}]},社内共有が必要な事項:{rich_text:[{text:{content:h||"なし"}}]}}),E=[{type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:k}}]}}],L=async e=>{let t=v();return await g.pages.create({parent:{database_id:e},properties:t,children:E})};try{let e=await Promise.all([D,y,N].map(e=>L(e.db_id)));return await b.from("transcription_tasks").update({notion_page_id:JSON.stringify({all:e[0].id,consultant:e[1].id,company:e[2].id})}).eq("id",o),d.NextResponse.json({message:"Notion pages created",ids:e.map(e=>e.id)})}catch(e){return await b.from("transcription_tasks").update({status:"notion_failed",error_message:e.message}).eq("id",o),d.NextResponse.json({error:"Failed to create notion pages",details:e.message},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/notion-sync/route",pathname:"/api/notion-sync",filename:"route",bundlePath:"app/api/notion-sync/route"},resolvedPagePath:"C:\\Dagitoru-mtglog\\app\\api\\notion-sync\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:j,workUnitAsyncStorage:h,serverHooks:k}=_;function R(){return(0,s.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:h})}},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5828:()=>{throw Error('Module build failed: UnhandledSchemeError: Reading from "npm:@supabase/supabase-js" is not handled by plugins (Unhandled scheme).\nWebpack supports "data:" and "file:" URIs by default.\nYou may need an additional plugin to handle "npm:" URIs.\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408376\n    at Hook.eval [as callAsync] (eval at create (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:14:9224), <anonymous>:6:1)\n    at Object.processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408301)\n    at processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:5308)\n    at iteratePitchingLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:4667)\n    at runLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:8590)\n    at NormalModule._doBuild (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408163)\n    at NormalModule.build (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:410176)\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:82494\n    at NormalModule.needBuild (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:414126)')},6487:()=>{},6891:()=>{throw Error('Module build failed: UnhandledSchemeError: Reading from "npm:@notionhq/client" is not handled by plugins (Unhandled scheme).\nWebpack supports "data:" and "file:" URIs by default.\nYou may need an additional plugin to handle "npm:" URIs.\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408376\n    at Hook.eval [as callAsync] (eval at create (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:14:9224), <anonymous>:6:1)\n    at Hook.CALL_ASYNC_DELEGATE [as _callAsync] (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:14:6378)\n    at Object.processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408301)\n    at processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:5308)\n    at iteratePitchingLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:4667)\n    at runLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:8590)\n    at NormalModule._doBuild (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408163)\n    at NormalModule.build (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:410176)\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:82494')},7574:()=>{throw Error('Module build failed: UnhandledSchemeError: Reading from "npm:next/server" is not handled by plugins (Unhandled scheme).\nWebpack supports "data:" and "file:" URIs by default.\nYou may need an additional plugin to handle "npm:" URIs.\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408376\n    at Hook.eval [as callAsync] (eval at create (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:14:9224), <anonymous>:6:1)\n    at Object.processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408301)\n    at processResource (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:5308)\n    at iteratePitchingLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:4667)\n    at runLoaders (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\loader-runner\\LoaderRunner.js:1:8590)\n    at NormalModule._doBuild (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:408163)\n    at NormalModule.build (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:410176)\n    at C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:82494\n    at NormalModule.needBuild (C:\\Dagitoru-mtglog\\node_modules\\next\\dist\\compiled\\webpack\\bundle5.js:29:414126)')},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[297],()=>n(3708));module.exports=o})();