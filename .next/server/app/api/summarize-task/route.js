(()=>{var e={};e.id=821,e.ids=[821],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1997:e=>{"use strict";e.exports=require("punycode")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},6487:()=>{},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},8617:(e,t,n)=>{"use strict";n.r(t),n.d(t,{patchFetch:()=>ef,routeModule:()=>ec,serverHooks:()=>eh,workAsyncStorage:()=>eu,workUnitAsyncStorage:()=>ed});var s,o,r,a,i,l,c,u,d,h,f,p,m={};n.r(m),n.d(m,{POST:()=>el});var g=n(6559),E=n(8088),C=n(7719),O=n(2190),_=n(6345);!function(e){e.STRING="string",e.NUMBER="number",e.INTEGER="integer",e.BOOLEAN="boolean",e.ARRAY="array",e.OBJECT="object"}(s||(s={})),function(e){e.LANGUAGE_UNSPECIFIED="language_unspecified",e.PYTHON="python"}(o||(o={})),function(e){e.OUTCOME_UNSPECIFIED="outcome_unspecified",e.OUTCOME_OK="outcome_ok",e.OUTCOME_FAILED="outcome_failed",e.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"}(r||(r={}));let y=["user","model","function","system"];!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",e.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY"}(a||(a={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(i||(i={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(l||(l={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(c||(c={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.LANGUAGE="LANGUAGE",e.BLOCKLIST="BLOCKLIST",e.PROHIBITED_CONTENT="PROHIBITED_CONTENT",e.SPII="SPII",e.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",e.OTHER="OTHER"}(u||(u={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(d||(d={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(h||(h={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.MODE_DYNAMIC="MODE_DYNAMIC"}(f||(f={}));class I extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class S extends I{constructor(e,t){super(e),this.response=t}}class w extends I{constructor(e,t,n,s){super(e),this.status=t,this.statusText=n,this.errorDetails=s}}class T extends I{}class N extends I{}!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(p||(p={}));class R{constructor(e,t,n,s,o){this.model=e,this.task=t,this.apiKey=n,this.stream=s,this.requestOptions=o}toString(){var e,t;let n=(null==(e=this.requestOptions)?void 0:e.apiVersion)||"v1beta",s=(null==(t=this.requestOptions)?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com",o=`${s}/${n}/${this.model}:${this.task}`;return this.stream&&(o+="?alt=sse"),o}}async function v(e){var t;let n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",function(e){let t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.24.1"),t.join(" ")}(e.requestOptions)),n.append("x-goog-api-key",e.apiKey);let s=null==(t=e.requestOptions)?void 0:t.customHeaders;if(s){if(!(s instanceof Headers))try{s=new Headers(s)}catch(e){throw new T(`unable to convert customHeaders value ${JSON.stringify(s)} to Headers: ${e.message}`)}for(let[e,t]of s.entries()){if("x-goog-api-key"===e)throw new T(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new T(`Header name ${e} can only be set using the apiClient field`);n.append(e,t)}}return n}async function A(e,t,n,s,o,r){let a=new R(e,t,n,s,r);return{url:a.toString(),fetchOptions:Object.assign(Object.assign({},function(e){let t={};if((null==e?void 0:e.signal)!==void 0||(null==e?void 0:e.timeout)>=0){let n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}(r)),{method:"POST",headers:await v(a),body:o})}}async function b(e,t,n,s,o,r={},a=fetch){let{url:i,fetchOptions:l}=await A(e,t,n,s,o,r);return k(i,l,a)}async function k(e,t,n=fetch){let s;try{s=await n(e,t)}catch(n){var o=n,r=e;let t=o;throw"AbortError"===t.name?(t=new N(`Request aborted when fetching ${r.toString()}: ${o.message}`)).stack=o.stack:o instanceof w||o instanceof T||((t=new I(`Error fetching from ${r.toString()}: ${o.message}`)).stack=o.stack),t}return s.ok||await x(s,e),s}async function x(e,t){let n,s="";try{let t=await e.json();s=t.error.message,t.error.details&&(s+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new w(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${s}`,e.status,e.statusText,n)}function M(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new S(`${P(e)}`,e);return function(e){var t,n,s,o;let r=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(o=null==(s=e.candidates)?void 0:s[0].content)?void 0:o.parts)t.text&&r.push(t.text),t.executableCode&&r.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&r.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return r.length>0?r.join(""):""}(e)}if(e.promptFeedback)throw new S(`Text not available. ${P(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new S(`${P(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),D(e)[0]}if(e.promptFeedback)throw new S(`Function call not available. ${P(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),j(e.candidates[0]))throw new S(`${P(e)}`,e);return D(e)}if(e.promptFeedback)throw new S(`Function call not available. ${P(e)}`,e)},e}function D(e){var t,n,s,o;let r=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(o=null==(s=e.candidates)?void 0:s[0].content)?void 0:o.parts)t.functionCall&&r.push(t.functionCall);return r.length>0?r:void 0}let $=[u.RECITATION,u.SAFETY,u.LANGUAGE];function j(e){return!!e.finishReason&&$.includes(e.finishReason)}function P(e){var t,n,s;let o="";if((!e.candidates||0===e.candidates.length)&&e.promptFeedback)o+="Response was blocked",(null==(t=e.promptFeedback)?void 0:t.blockReason)&&(o+=` due to ${e.promptFeedback.blockReason}`),(null==(n=e.promptFeedback)?void 0:n.blockReasonMessage)&&(o+=`: ${e.promptFeedback.blockReasonMessage}`);else if(null==(s=e.candidates)?void 0:s[0]){let t=e.candidates[0];j(t)&&(o+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(o+=`: ${t.finishMessage}`))}return o}function L(e){return this instanceof L?(this.v=e,this):new L(e)}"function"==typeof SuppressedError&&SuppressedError;let U=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function q(e){let t=[],n=e.getReader();for(;;){let{done:e,value:s}=await n.read();if(e)return M(function(e){let t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(let t of e){if(t.candidates){let e=0;for(let s of t.candidates)if(n.candidates||(n.candidates=[]),n.candidates[e]||(n.candidates[e]={index:e}),n.candidates[e].citationMetadata=s.citationMetadata,n.candidates[e].groundingMetadata=s.groundingMetadata,n.candidates[e].finishReason=s.finishReason,n.candidates[e].finishMessage=s.finishMessage,n.candidates[e].safetyRatings=s.safetyRatings,s.content&&s.content.parts){n.candidates[e].content||(n.candidates[e].content={role:s.content.role||"user",parts:[]});let t={};for(let o of s.content.parts)o.text&&(t.text=o.text),o.functionCall&&(t.functionCall=o.functionCall),o.executableCode&&(t.executableCode=o.executableCode),o.codeExecutionResult&&(t.codeExecutionResult=o.codeExecutionResult),0===Object.keys(t).length&&(t.text=""),n.candidates[e].content.parts.push(t)}e++}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}(t));t.push(s)}}async function H(e,t,n,s){let[o,r]=(function(e){let t=e.getReader();return new ReadableStream({start(e){let n="";return function s(){return t.read().then(({value:t,done:o})=>{let r;if(o)return n.trim()?void e.error(new I("Failed to parse stream")):void e.close();let a=(n+=t).match(U);for(;a;){try{r=JSON.parse(a[1])}catch(t){e.error(new I(`Error parsing JSON response: "${a[1]}"`));return}e.enqueue(r),a=(n=n.substring(a[0].length)).match(U)}return s()}).catch(e=>{let t=e;throw t.stack=e.stack,t="AbortError"===t.name?new N("Request aborted when reading from the stream"):new I("Error reading from the stream")})}()}})})((await b(t,p.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),s)).body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))).tee();return{stream:function(e){return function(e,t,n){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var s,o=n.apply(e,t||[]),r=[];return s={},a("next"),a("throw"),a("return"),s[Symbol.asyncIterator]=function(){return this},s;function a(e){o[e]&&(s[e]=function(t){return new Promise(function(n,s){r.push([e,t,n,s])>1||i(e,t)})})}function i(e,t){try{var n;(n=o[e](t)).value instanceof L?Promise.resolve(n.value.v).then(l,c):u(r[0][2],n)}catch(e){u(r[0][3],e)}}function l(e){i("next",e)}function c(e){i("throw",e)}function u(e,t){e(t),r.shift(),r.length&&i(r[0][0],r[0][1])}}(this,arguments,function*(){let t=e.getReader();for(;;){let{value:e,done:n}=yield L(t.read());if(n)break;yield yield L(M(e))}})}(o),response:q(r)}}async function F(e,t,n,s){let o=await b(t,p.GENERATE_CONTENT,e,!1,JSON.stringify(n),s);return{response:M(await o.json())}}function G(e){if(null!=e){if("string"==typeof e)return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)if(!e.role)return{role:"system",parts:e.parts};else return e}}function B(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(let n of e)"string"==typeof n?t.push({text:n}):t.push(n);var n=t;let s={role:"user",parts:[]},o={role:"function",parts:[]},r=!1,a=!1;for(let e of n)"functionResponse"in e?(o.parts.push(e),a=!0):(s.parts.push(e),r=!0);if(r&&a)throw new I("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!a)throw new I("No content is provided for sending chat message.");return r?s:o}function K(e){let t;return t=e.contents?e:{contents:[B(e)]},e.systemInstruction&&(t.systemInstruction=G(e.systemInstruction)),t}let z=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],Y={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function J(e){var t;if(void 0===e.candidates||0===e.candidates.length)return!1;let n=null==(t=e.candidates[0])?void 0:t.content;if(void 0===n||void 0===n.parts||0===n.parts.length)return!1;for(let e of n.parts)if(void 0===e||0===Object.keys(e).length||void 0!==e.text&&""===e.text)return!1;return!0}let V="SILENT_ERROR";class W{constructor(e,t,n,s={}){this.model=t,this.params=n,this._requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(!function(e){let t=!1;for(let n of e){let{role:e,parts:s}=n;if(!t&&"user"!==e)throw new I(`First content should be with role 'user', got ${e}`);if(!y.includes(e))throw new I(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(y)}`);if(!Array.isArray(s))throw new I("Content should have 'parts' property with an array of Parts");if(0===s.length)throw new I("Each Content should have at least one part");let o={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let e of s)for(let t of z)t in e&&(o[t]+=1);let r=Y[e];for(let t of z)if(!r.includes(t)&&o[t]>0)throw new I(`Content with role '${e}' can't contain '${t}' part`);t=!0}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,s,o,r,a,i;let l;await this._sendPromise;let c=B(e),u={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(s=this.params)?void 0:s.generationConfig,tools:null==(o=this.params)?void 0:o.tools,toolConfig:null==(r=this.params)?void 0:r.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(i=this.params)?void 0:i.cachedContent,contents:[...this._history,c]},d=Object.assign(Object.assign({},this._requestOptions),t);return this._sendPromise=this._sendPromise.then(()=>F(this._apiKey,this.model,u,d)).then(e=>{var t;if(J(e.response)){this._history.push(c);let n=Object.assign({parts:[],role:"model"},null==(t=e.response.candidates)?void 0:t[0].content);this._history.push(n)}else{let t=P(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e}).catch(e=>{throw this._sendPromise=Promise.resolve(),e}),await this._sendPromise,l}async sendMessageStream(e,t={}){var n,s,o,r,a,i;await this._sendPromise;let l=B(e),c={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(s=this.params)?void 0:s.generationConfig,tools:null==(o=this.params)?void 0:o.tools,toolConfig:null==(r=this.params)?void 0:r.toolConfig,systemInstruction:null==(a=this.params)?void 0:a.systemInstruction,cachedContent:null==(i=this.params)?void 0:i.cachedContent,contents:[...this._history,l]},u=Object.assign(Object.assign({},this._requestOptions),t),d=H(this._apiKey,this.model,c,u);return this._sendPromise=this._sendPromise.then(()=>d).catch(e=>{throw Error(V)}).then(e=>e.response).then(e=>{if(J(e)){this._history.push(l);let t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{let t=P(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==V&&console.error(e)}),d}}async function X(e,t,n,s){return(await b(t,p.COUNT_TOKENS,e,!1,JSON.stringify(n),s)).json()}async function Q(e,t,n,s){return(await b(t,p.EMBED_CONTENT,e,!1,JSON.stringify(n),s)).json()}async function Z(e,t,n,s){let o=n.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await b(t,p.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:o}),s)).json()}class ee{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=G(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;let s=K(e),o=Object.assign(Object.assign({},this._requestOptions),t);return F(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},s),o)}async generateContentStream(e,t={}){var n;let s=K(e),o=Object.assign(Object.assign({},this._requestOptions),t);return H(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},s),o)}startChat(e){var t;return new W(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(t=this.cachedContent)?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let n=function(e,t){var n;let s={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null==(n=null==t?void 0:t.cachedContent)?void 0:n.name,contents:[]},o=null!=e.generateContentRequest;if(e.contents){if(o)throw new T("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=e.contents}else if(o)s=Object.assign(Object.assign({},s),e.generateContentRequest);else{let t=B(e);s.contents=[t]}return{generateContentRequest:s}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return X(this.apiKey,this.model,n,s)}async embedContent(e,t={}){let n="string"==typeof e||Array.isArray(e)?{content:B(e)}:e,s=Object.assign(Object.assign({},this._requestOptions),t);return Q(this.apiKey,this.model,n,s)}async batchEmbedContents(e,t={}){let n=Object.assign(Object.assign({},this._requestOptions),t);return Z(this.apiKey,this.model,e,n)}}class et{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new I("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new ee(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new T("Cached content must contain a `name` field.");if(!e.model)throw new T("Cached content must contain a `model` field.");for(let n of["model","systemInstruction"])if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new T(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}let s=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new ee(this.apiKey,s,n)}}let en="https://tqeprgfaybkvknmzeraj.supabase.co",es=process.env.SUPABASE_SERVICE_ROLE_KEY,eo=process.env.WEBHOOK_SECRET,er=process.env.GEMINI_API_KEY,ea=null;en&&es?ea=(0,_.UU)(en,es,{auth:{persistSession:!1,autoRefreshToken:!1}}):console.error("[summarize-task/route.ts] Missing Supabase URL or Service Role Key env vars.");let ei=null;async function el(e){let t;console.log(`[${new Date().toISOString()}] /api/summarize-task: POST request received.`);let n=e.headers.get("Authorization");if(!eo||!n||!n.startsWith("Bearer ")||n.substring(7)!==eo)return console.warn(`[${new Date().toISOString()}] /api/summarize-task: Unauthorized access attempt.`),O.NextResponse.json({error:"Unauthorized"},{status:401});if(console.log(`[${new Date().toISOString()}] /api/summarize-task: Authorization successful.`),!ea)return console.error(`[${new Date().toISOString()}] /api/summarize-task: Supabase client is not initialized.`),O.NextResponse.json({error:"Server configuration error: Supabase client not available."},{status:500});if(!ei)return console.error(`[${new Date().toISOString()}] /api/summarize-task: Gemini AI client is not initialized.`),O.NextResponse.json({error:"Server configuration error: Gemini AI client not available."},{status:500});try{if(!(t=await e.json()).taskId||"string"!=typeof t.taskId||!t.transcript||"string"!=typeof t.transcript)throw Error("Invalid request body: taskId and transcript are required and must be strings.")}catch(t){let e=t instanceof Error?t.message:"Unknown error parsing request body.";return console.error(`[${new Date().toISOString()}] /api/summarize-task: Error parsing request body: ${e}`),O.NextResponse.json({error:"Invalid request body",details:e},{status:400})}let{taskId:s,transcript:o}=t;console.log(`[${new Date().toISOString()}] /api/summarize-task: Parsed request for taskId: ${s}`);let r=null;try{let{data:e,error:t}=await ea.from("transcription_tasks").select("consultant_name, company_name, company_type, company_problem, meeting_date, meeting_count, meeting_type, support_area").eq("id",s).single();if(t){if("PGRST116"===t.code)return console.warn(`[${new Date().toISOString()}] /api/summarize-task: Task not found in DB for taskId: ${s}`),O.NextResponse.json({error:"Task not found"},{status:404});throw t}r=e,console.log(`[${new Date().toISOString()}] /api/summarize-task: Successfully fetched metadata for taskId ${s}:`,r)}catch(t){let e=t instanceof Error?t.message:"Unknown DB error.";return console.error(`[${new Date().toISOString()}] /api/summarize-task: Error fetching metadata from DB for taskId ${s}: ${e}`),O.NextResponse.json({error:"Failed to fetch task metadata",details:e},{status:500})}try{let{error:e}=await ea.from("transcription_tasks").update({status:"summarizing",updated_at:new Date().toISOString()}).eq("id",s);if(e)throw e;console.log(`[${new Date().toISOString()}] /api/summarize-task: Successfully updated status to 'summarizing' for taskId: ${s}`)}catch(t){let e=t instanceof Error?t.message:"Unknown DB error during status update.";return console.error(`[${new Date().toISOString()}] /api/summarize-task: Error updating status to summarizing for taskId ${s}: ${e}`),O.NextResponse.json({error:"Failed to update task status",details:e},{status:500})}console.log(`[${new Date().toISOString()}] /api/summarize-task: Initial processing complete for taskId: ${s}. Transcript length: ${o.length}`),console.log("Task Metadata:",r);let a=o.length>6e4?o.slice(-6e4):o,i=ei.getGenerativeModel({model:"gemini-pro"}),l=e=>{if(!e)return"";let t=Object.entries(e).filter(([e,t])=>null!=t&&""!==t).map(([e,t])=>`- ${e}: ${t}`).join("\n");return t?`以下はミーティングのメタ情報です:
${t}
`:""},c=async(e,t,n)=>{let s="";switch(e){case"phase1":s=`あなたは優秀な議事録作成アシスタントです。${l(t)}
「議事の要点」を日本語で箇条書き（最大10項目）にまとめ、以下のJSON形式で返してください。
{
  "key_points": string[]
}`;break;case"phase2":s=`あなたは優秀な議事録作成アシスタントです。${l(t)}
以下の文字起こしを論理的な章立て（アジェンダ）に分割し、各章タイトルを生成してください。JSON形式:
{
  "sections": { "title": string, "summary": string }[]
}`;break;case"phase3":s=`あなたは優秀な議事録作成アシスタントです。${l(t)}
以下の文字起こしを話者ごとにまとめ、各話者ごとに発言要約を作成し、重要ポイントを抽出してください。JSON形式:
{
  "speakers": { "name": string, "summary": string }[]
}`}let o=`${s}
--- 文字起こしここから ---
${n}
--- 文字起こしここまで ---`;try{let e=(await i.generateContent(o)).response.text(),t=e.match(/\{[\s\S]*\}/);if(!t)throw Error("JSON not found in model output");return{json:JSON.parse(t[0]),rawText:e}}catch(t){throw console.error(`[summarize-task] ${e} failed:`,t),Error(`${e}_failed`)}},u=null,d=null,h=null;try{[u,d,h]=await Promise.all([c("phase1",r,a),c("phase2",r,a),c("phase3",r,a)]),console.log(`[summarize-task] Phase1-3 completed for taskId ${s}`)}catch(t){let e=t instanceof Error?t.message:String(t);return await ea.from("transcription_tasks").update({status:"summarize_failed",updated_at:new Date().toISOString()}).eq("id",s),O.NextResponse.json({error:"Summarization failed",details:e},{status:500})}let f="";try{let e=`あなたはプロのコンサルタントです。与えられたフェーズ1-3の結果をもとに、ミーティング議事録を日本語で1000字以内のMarkdownにまとめてください。

## メタ情報
${l(r)}

## フェーズ1 要点
${JSON.stringify(u.json)}

## フェーズ2 章立て
${JSON.stringify(d.json)}

## フェーズ3 話者別まとめ
${JSON.stringify(h.json)}

## 出力フォーマット
- タイトル行として "# 議事メモ" を含める
- 適切なMarkdown見出しを用いる
- 1000字以内に収める`;f=(await i.generateContent(e)).response.text()}catch(t){let e=t instanceof Error?t.message:String(t);return console.error("[summarize-task] Phase4 failed:",e),await ea.from("transcription_tasks").update({status:"summarize_failed",updated_at:new Date().toISOString()}).eq("id",s),O.NextResponse.json({error:"Final summary generation failed",details:e},{status:500})}try{let{error:e}=await ea.from("transcription_tasks").update({phase1_output:u.json,phase2_output:d.json,phase3_output:h.json,final_summary:f,status:"completed",updated_at:new Date().toISOString()}).eq("id",s);if(e)throw e}catch(t){let e=t instanceof Error?t.message:"Unknown DB error";return console.error(`[summarize-task] DB save failed for taskId ${s}:`,e),await ea.from("transcription_tasks").update({status:"summarize_failed",updated_at:new Date().toISOString()}).eq("id",s),O.NextResponse.json({error:"Failed to save summary",details:e},{status:500})}return console.log(`[summarize-task] All phases completed for taskId ${s}`),O.NextResponse.json({message:"Summarization completed",taskId:s,phase1:u.json,phase2:d.json,phase3:h.json,finalSummary:f})}er?ei=new et(er):console.error("[summarize-task/route.ts] Missing GEMINI_API_KEY env var.");let ec=new g.AppRouteRouteModule({definition:{kind:E.RouteKind.APP_ROUTE,page:"/api/summarize-task/route",pathname:"/api/summarize-task",filename:"route",bundlePath:"app/api/summarize-task/route"},resolvedPagePath:"C:\\Dagitoru-mtglog\\app\\api\\summarize-task\\route.ts",nextConfigOutput:"",userland:m}),{workAsyncStorage:eu,workUnitAsyncStorage:ed,serverHooks:eh}=ec;function ef(){return(0,C.patchFetch)({workAsyncStorage:eu,workUnitAsyncStorage:ed})}},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),s=t.X(0,[297,190,345],()=>n(8617));module.exports=s})();